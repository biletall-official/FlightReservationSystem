@using UçakDemo.Models.InternationalSefer
@using Segment = UçakDemo.Models.Sefer.Segment
@model UçakDemo.Services.YurtdisiSeferListesi

<h2>Yurtdışı Seferler</h2>

@if (Model.InternationalSegmentler != null && Model.InternationalSegmentler.Any())
{
    <div class="card-container">
        @foreach (var ucus in Model.InternationalSegmentler.GroupBy(g => g.UcusID))
        {
            var firstSegment = @ucus.FirstOrDefault();
            var lastSegment = @ucus.LastOrDefault();
            var ucret = Model.InternationalSecenekler.FirstOrDefault(s => s.ID == firstSegment.SecenekID);
            <div class="card"style="padding: 20px; min-height: 100px;">
                
                @* <p>TK-VF </p> *@
                <div style="display: flex; align-items: center;">
                    <div style="margin-right: 10px;">
                        <div>@string.Join('-', ucus.Select(segment => segment.HavaYolu))</div>
                    </div>
                    <div style="margin-left: 20px;">
                        <span>@($"{firstSegment?.KalkisTarih:HH:mm}")</span><br/>
                        <strong>@($"{firstSegment?.KalkisSehir} ({firstSegment?.KalkisKod})") </strong>
                    </div>
                    <div style="position: relative; flex-direction: column; margin: 0 20px;align-items: center; justify-content: center;text-align: center; color: gray;">
                        <strong>      </strong>
                        <span>@($"{firstSegment?.UcusSuresi }")dk</span><br/>
                        <strong>-------></strong>
                    </div>
                    <div>
                        <div style="margin-left: 20px;">
                            <span>@($"{lastSegment?.VarisTarih:HH:mm}")</span><br/>
                            <strong>@($"{lastSegment?.VarisSehir} ({lastSegment?.VarisKod})") </strong>
                        </div>
                    </div>
                    <div>
                        <div style="margin-left: 20px;">
                            <span>Kalan @firstSegment?.KalanKoltukSayi Koltuk </span>
                        </div>
                    </div>
                    <div style="margin-left: 40px; cursor: pointer;">
                        <div style="border: 2px solid red; padding: 10px; display: inline-block; color: red;">
                            <div onclick="validatePrice(@firstSegment.UcusID, '@ucret.ToplamFiyatE', '@firstSegment.KalkisSehir', '@lastSegment.VarisSehir')">
                                <span>@ucret?.ToplamFiyatE TL </span><br/>
                            </div>
                        </div>
                        <div style="cursor: pointer; margin-top: 10px;" onclick="toggleDetails('detailsPanel_@ucus.Key')">
                            <span>Detaylı Bilgi</span>
                        </div>
                    </div>
                </div>
                <div id="detailsPanel_@ucus.Key" class="details-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Detaylı Bilgi</h3>
                        <button onclick="toggleDetails('detailsPanel_@ucus.Key')" style="background: none; border: none; font-size: 20px; cursor: pointer;">&#10006;</button>
                    </div>
                    <div>
                        @foreach (var segment in ucus)
                        {
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>@segment.HavaYolu</strong><br/>
                                @($"{segment.KalkisTarih:dd MMM ddd} - {segment.KalkisTarih:HH:mm}") - @segment.KalkisSehir - @segment.KalkisKod <br/>
                                @($"{segment.VarisTarih:dd MMM ddd} - {segment.VarisTarih:HH:mm}") - @segment.VarisSehir - @segment.VarisKod
                            </div>
                            <div style="text-align: right;">
                                <span>Sadece El Bagajı</span><br/>
                                Uçuş No: @segment.UcusID Sınıf: @segment.Sinif
                            </div>
                        </div>
                        @if (segment != lastSegment)
                        {
                        <div style="color: red; text-align: center; margin: 10px 0;">
                            @($"Bekleme süresi: {segment.VarisTarih.AddHours(8).ToString("HH:mm")}")
                        </div>
                        }
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p>Sefer bulunamadı.</p>
}
@section Scripts
{
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        
    //$(document).ready(function () {
        function validatePrice(ucusID, toplamFiyatE, kalkisSehir, varisSehir) {
            console.log(`Uçuş ID: ${ucusID}, Toplam Fiyat: ${toplamFiyatE}, Kalkış Şehri: ${kalkisSehir}, Varış Şehri: ${varisSehir}`);
            $.ajax({
                url: '/Flight/ValidatePrice',
                type: 'POST',
                data:{ucusID,fiyat:toplamFiyatE,kalkisSehir,varisSehir},
                success: function (response) {
                    console.log(response)
                    if (response.isValid) {

                        window.location.href = '/PassengerInfo';
                    } else {
                        alert('Fiyat geçersiz.');
                    }
                },
                error: function () {
                    alert('Bir hata oluştu.');
                }
            });
        }
    //});
    function toggleDetails(panelId) {
        var detailsPanel = document.getElementById(panelId);
        if (detailsPanel.style.display === 'none' || detailsPanel.style.display === '') {
            detailsPanel.style.display = 'block';
        } else {
            detailsPanel.style.display = 'none';
        }
    }

    </script>
}
<button id="validatePriceBtn">Fiyatı Doğrula ve Devam Et</button>

<style>
    .details-panel {
        display: none;
        position: absolute;
        width: 100%;
        background-color: white;
        border: 1px solid #ddd;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 1000;
    }
</style>